<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>历史</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    * {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    body {
      background: url("../images/history/history_bg.jpg") no-repeat;
      width: 1920px;
      height: 1080px;
      overflow: hidden;
    }

    .item,
    .area,
    .pic,
    .txt,
    .scrolls,
    .item_bg,
    .select {
      position: absolute;
    }

    .tit .txt {
      height: 70px;
      line-height: 60px;
      font-size: 32px;
      width: 600px;
      left: 90px;
    }

    .area_0 .item .item_bg {
      width: 169px;
      height: 232px;
      border-radius: 10px;
      background-color: #2684E9;
    }

    .area_0 .item .select {
      width: 169px;
      height: 232px;
      border: 5px solid #fff;
      border-radius: 10px;
      z-index: 20;
    }

    .area_0 .item .pic img {
      position: absolute;
      width: 163px;
      height: 226px;
      left: 3px;
      top: 3px;
      border-radius: 7px;
    }

    .area_0 .txt {
      width: 169px;
      height: 36px;
      line-height: 36px;
      text-align: center;
      top: 232px;
      font-size: 24px;
    }

    .area_0 .txt.episode {
      top: 268px;
      font-size: 22px;
    }

    .area_1 .item_focus .select {
      left: -2px;
      top: -1px;
    }

    #total_num {
      color: #FFF000;
      font-size: 48px;
      position: relative;
      top: 2px;
    }

    #scroll_bar {
      width: 35px;
      height: 566px;
      background-color: #454C68;
      opacity: 0.9;
      border-radius: 16px;
    }

    .scroll {
      position: relative;
      line-height: 0;
      left: 0;
      top: 0;
      width: 14px;
      height: 10px;
      background-color: #00A0E9;
    }

    .scroll_0 {
      border-radius: 6px 6px 0 0;
    }

    .scroll_1 {
      height: 133px;
    }

    .scroll_2 {
      border-radius: 0 0 6px 6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!--文字信息-->
    <div class="item tit" style="left: 302px;top: 205px;">
      <div class="pic"><img src="../images/history/icon_history.png" alt=""></div>
      <div class="txt">全部节目 | 共 <span id="total_num">00</span> 部</div>
    </div>
    <!--节目-->
    <div class="area area_0" style="left:303px;top:322px;">
      <div class="item" id="area0_item_0" style="left: 0px;">
        <div class="item_bg"></div>
        <div class="pic"><img id="area0_pic_0" src="../images/history/poster.png" alt=""></div>
        <div class="select"></div>
        <div class="txt" id="area0_txt_0"></div>
        <div class="txt episode" id="area0_episode_0">01集</div>
      </div>
      <div class="item" id="area0_item_1" style="left: 224px;">
        <div class="pic"><img id="area0_pic_1" src="../images/history/poster.png" alt=""></div>
        <div class="select"></div>
        <div class="txt" id="area0_txt_1"></div>
        <div class="txt episode" id="area0_episode_1">01集</div>
      </div>
      <div class="item" id="area0_item_2" style="left: 448px;">
        <div class="pic"><img id="area0_pic_2" src="../images/history/poster.png" alt=""></div>
        <div class="select"></div>
        <div class="txt" id="area0_txt_2"></div>
        <div class="txt episode" id="area0_episode_2">01集</div>
      </div>
      <div class="item" id="area0_item_3" style="left: 673px;">
        <div class="pic"><img id="area0_pic_3" src="../images/history/poster.png" alt=""></div>
        <div class="select"></div>
        <div class="txt" id="area0_txt_3"></div>
        <div class="txt episode" id="area0_episode_3">01集</div>
      </div>
      <div class="item" id="area0_item_4" style="left: 897px;">
        <div class="pic"><img id="area0_pic_4" src="../images/history/poster.png" alt=""></div>
        <div class="select"></div>
        <div class="txt" id="area0_txt_4"></div>
        <div class="txt episode" id="area0_episode_4">01集</div>
      </div>
      <div class="item" id="area0_item_5" style="left: 1124px;">
        <div class="pic"><img id="area0_pic_5" src="../images/history/poster.png" alt=""></div>
        <div class="select"></div>
        <div class="txt" id="area0_txt_5"></div>
        <div class="txt episode" id="area0_episode_5">01集</div>
      </div>
    </div>
    <!--删除按钮-->
    <div class="area area_1" style="left: 303px;top: 632px;margin-top:6px;">
      <div class="item" id="area1_item_0" style="left: 24px;">
        <div class="pic no-select"><img src="../images/history/del.png" alt=""></div>
        <div class="pic select"><img src="../images/history/del_s.png" alt=""></div>
      </div>
      <div class="item" id="area1_item_1" style="left: 248px;">
        <div class="pic no-select"><img src="../images/history/del.png" alt=""></div>
        <div class="pic select"><img src="../images/history/del_s.png" alt=""></div>
      </div>
      <div class="item" id="area1_item_2" style="left: 475px;">
        <div class="pic no-select"><img src="../images/history/del.png" alt=""></div>
        <div class="pic select"><img src="../images/history/del_s.png" alt=""></div>
      </div>
      <div class="item" id="area1_item_3" style="left: 700px;">
        <div class="pic no-select"><img src="../images/history/del.png" alt=""></div>
        <div class="pic select"><img src="../images/history/del_s.png" alt=""></div>
      </div>
      <div class="item" id="area1_item_4" style="left: 924px;">
        <div class="pic no-select"><img src="../images/history/del.png" alt=""></div>
        <div class="pic select"><img src="../images/history/del_s.png" alt=""></div>
      </div>
      <div class="item" id="area1_item_5" style="left: 1151px;">
        <div class="pic no-select"><img src="../images/history/del.png" alt=""></div>
        <div class="pic select"><img src="../images/history/del_s.png" alt=""></div>
      </div>
    </div>
    <!--滚动条-->
    <div class="item" id="scroll_box" style="left: 1661px;top: 314px;">
      <div class="item" id="scroll_bar"></div>
      <div class="scrolls" style="left: 10px;top: 10px;">
        <div class="scroll scroll_0"></div>
        <div class="scroll scroll_1"></div>
        <div class="scroll scroll_2"></div>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="../js/WkEpg3.0.js"></script>
  <script type="text/javascript" src="../js/jquery-1.8.3.min.js"></script>
  <script>
    var pageobj;
    (function(window, document) {
      var area0, area1;
      var url = window.location.href;
      var indexid = !WkEpg.Util.getURLParameter("indexid", url) ? 0 : parseInt(WkEpg.Util.getURLParameter("indexid", url)); //焦点数据
      var areaid = !WkEpg.Util.getURLParameter("areaid", url) ? 0 : parseInt(WkEpg.Util.getURLParameter("areaid", url)); //焦点数据
      var realindex = !WkEpg.Util.getURLParameter("realindex", url) ? 0 : parseInt(WkEpg.Util.getURLParameter("realindex", url));
      var returnurl = !WkEpg.Util.getURLParameter("returnurl", url) ? "index.html" : decodeURIComponent(WkEpg.Util.getURLParameter("returnurl", url));

      var focusObj = null;
      var dataObj = null;
      var controlObj = null;
      var pageSize = 6;
      var nameCut = 6;
      var records = '';
      var total = '';

      var API_URL = "http://112.45.191.68:8081/api";

      var STATIC_RESOUCE_URL = "http://112.45.191.68:8081";

      var USERID = 2;

      //焦点移动类
      function FocusMove() {
        this.createArea();
        this.createFunction();
        this.marqueeName();
      }
      FocusMove.prototype = {
        createArea: function() {
          //@ Array(上、左、下、右)
          //@ area.stablemoveindex("fromIndex-toId>toIndex")
          area0 = WkEpg.AreaCreator(1, 6, [-1, -1, 1, -1], "area0_item_", "className:item item_focus", "className:item");
          area1 = WkEpg.AreaCreator(1, 6, [0, -1, -1, -1], "area1_item_", "className:item item_focus", "className:item");

          area0.stablemoveindex = ["0-1>0", -1, "0-1>0,1-1>1,2-1>2,3-1>3,4-1>4,5-1>5", -1];
          area1.stablemoveindex = ["0-0>0,1-0>1,2-0>2,3-0>3,4-0>4,5-0>5", -1, -1, -1];

          pageobj = WkEpg.PageCreator(areaid, indexid, new Array(area0, area1));
          area0.setbroadwiseCrossturnpage(true); //设置横向自动翻页
          area0.curpage = 1;
        },
        createFunction: function() {
          area0.areaOkEvent = function() {
            window.location.href = "detail.html?programid=" + records[this.curindex]['program_id'] + "&returnurl=" + encodeURIComponent(dataObj.getReturnUrl(this.id, this.curindex));
          }
          area0.areaPageTurnEvent = function(num) {
            if (this.pagecount <= 1) {
              return;
            }
            this.lock = true;
            dataObj.loadPrograms();
          };
          area1.areaOkEvent = function() {
            dataObj.delCollect(this.curindex);
          }

          WkEpg.Nav.keyBackEvent = function() {
            WkEpg.Util.gotoPage(returnurl);
          };
        },
        marqueeName: function() {
          area0.changefocusAfterEvent = function() {
            if (this.doms[this.curindex] != undefined && WkEpg.Util.getStrRealLen(this.doms[this.curindex].contentName) > nameCut * 2)
              $("#area0_txt_" + this.curindex).html("<marquee direction='left' scrolldelay='100'>" + this.doms[this.curindex].contentName + "</marquee>");
          };
          area0.changeunfocusBeforeEvent = function() {
            if (this.doms[this.curindex] != undefined && WkEpg.Util.getStrRealLen(this.doms[this.curindex].contentName) > nameCut * 2)
              $("#area0_txt_" + this.curindex).html(WkEpg.Util.getSubStr(this.doms[this.curindex].contentName, nameCut * 2, true));
          };
          if (pageobj.curareaid == 2)
            pageobj.areas[pageobj.curareaid].changefocusAfterEvent();
        }
      };

      //Dom操作类 页面滑动 轮播
      function DomControl() {
        this.pageSize = 6;
      }
      DomControl.prototype = {
        renderPrograms: function(items) {
          $('#total_num').html(total < 10 ? '0' + total : total);
          for (var i = 0; i < this.pageSize; i++) {
            if (i < area0.datanum) {
              area0.doms[i].contentName = items[i]['program_name'];
              $('#area0_pic_' + i).attr('src', STATIC_RESOUCE_URL + items[i]['program_posters']['vertical'])
              $('#area0_txt_' + i).html(items[i]['program_name']);
              $('#area0_txt_' + i).html(WkEpg.Util.getSubStr(items[i]['program_name'], nameCut * 2, true));
              $('#area0_item_' + i).show();
              $('#area1_item_' + i).show();
            } else {
              $('#area0_item_' + i).hide();
              $('#area1_item_' + i).hide();
            }
          }
          area0.lock = false;
          this.costScroll();
        },
        //计算滚动条长度，改变滚动条的位置
        costScroll: function() {
          if (area0.pagecount > 1) {
            var scrollsH = parseInt($('#scroll_bar').css('height')) / area0.pagecount - 20;
            $('.scrolls .scroll_1').css('height', scrollsH);
            totalScroll = parseInt($('#scroll_bar').css('height')) - parseInt($('.scrolls').css('height')) - 20;
            perScroll = totalScroll / (area0.pagecount - 1);
            this.perScroll = perScroll;
            var top = (area0.curpage - 1) * this.perScroll + 10;
            $('.scrolls').css('transition', 'top 200ms');
            $('.scrolls').css('top', top);
            $('#scroll_box').show();
          } else {
            $('#scroll_box').hide();
          }
        },
      };

      //加载数据的类
      function loadData() {
        this.loadPrograms();
        this.getReturnUrl();
      }
      loadData.prototype = {
        loadPrograms: function() {
          $.ajax({
            type: 'GET',
            url: API_URL + "/user/collects",
            cache: false,
            data: {
              "userID": USERID,
              "pageSize": 6,
              "page": area0.curpage,
              "timestamp": new Date().getTime()
            },
            dataType: "json",
            beforeSend: function(xhr) {
              xhr.setRequestHeader('Authorization', "Bearer " + md5(USERID))
            },
            success: function(res) {
              console.log(res)
              records = data = res.data;

              var pagination = res.meta.pagination;
              total = pagination.total;
              area0.datanum = pagination.count;
              area1.datanum = pagination.count;

              if (data.length == 0) {
                area0.datanum = 0;
                area1.datanum = 0;
              }
              //设置总页数
              area0.pagecount = pagination.total_pages;

              controlObj.renderPrograms(records);
            }
          })
        },
        delCollect: function(index) {
          var programID = records[index]['program_id'];

          $.ajax({
            type: "post",
            url: API_URL + "/removeCollect/" + programID,
            data: JSON.stringify({
              "userID": USERID,
            }),
            dataType: "json",
            beforeSend: function(xhr) {
              xhr.setRequestHeader('Authorization', "Bearer " + md5(USERID))
            },
            success: function(res) {
              console.log(res);
              var status = res.status;
              console.log(status)

              if (status) {
                //当删除最后一个收藏 光标移动到编辑
                //                            if (area0.datanum == 1) {
                //                                pageobj.changefocus(0, 0);
                //                                pageobj.areas[1].directions = new Array(-1, -1, -1, -1);
                //
                //                            } else {
                //                                if (index == 0)
                //                                    pageobj.changefocus(1, 1);
                //                                else
                //                                    pageobj.changefocus(1, index-1);
                //                            }
                dataObj.loadPrograms();
              }
            }
          });
        },
        getReturnUrl: function(areaid, indexid) {
          // realindex = (area1.curpage - 1) * pageSize + indexid;
          if (url.indexOf('?') > 0) {
            return url.split('?')[0] + "?realindex=" + realindex + "&areaid=" + areaid + "&indexid=" + indexid + "&returnurl=" + encodeURIComponent(returnurl);
          } else {
            return url + "?realindex=" + realindex + "&areaid=" + areaid + "&indexid=" + indexid + "&returnurl=" + encodeURIComponent(returnurl);
          }
        }
      };

      //初始化
      window.addEventListener("unload", function() {}, false);
      window.addEventListener("load", function() {
        window.focus();
        if (!focusObj) focusObj = new FocusMove();
        if (!controlObj) controlObj = new DomControl();
        if (!dataObj) dataObj = new loadData();
      }, false);
    })(window, document);
  </script>
</body>

</html>